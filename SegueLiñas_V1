from ultrasonic import Ultrasonic
from motor import Ordinary_Car
from servo import Servo
from infrared import Infrared
from adc import ADC
import time
import sys

class Car:
    def __init__(self):
        self.car_record_time = time.time()
        self.motor = Ordinary_Car()
        self.infrared = Infrared()
        # Initialize other components as needed
        # self.ultrasonic = Ultrasonic()
        # self.servo = Servo()
        # self.adc = ADC()
        
        # Configurable motor speeds
        self.SPEED_FORWARD = 800
        self.SPEED_TURN_MEDIUM = 1500
        self.SPEED_TURN_SHARP = 2000
        self.SPEED_TURN_VERY_SHARP = 4000
        
    def mode_infrared(self):
        """Infrared line following mode"""
        current_time = time.time()
        
        # Only process every 0.2 seconds to avoid over-processing
        if (current_time - self.car_record_time) > 0.2:
            self.car_record_time = current_time
            
            try:
                infrared_value = self.infrared.read_all_infrared()
                print(f"infrared_value: {infrared_value}")  # Debug logging
                
                # Handle different sensor patterns
                if infrared_value == 2:  # All center sensors on line
                    # Go straight
                    self.motor.set_motor_model(
                        self.SPEED_FORWARD, 
                        self.SPEED_FORWARD, 
                        self.SPEED_FORWARD, 
                        self.SPEED_FORWARD
                    )
                elif infrared_value == 4:  # Line slightly to the right
                    # Gentle left turn
                    self.motor.set_motor_model(
                        -self.SPEED_TURN_MEDIUM, 
                        -self.SPEED_TURN_MEDIUM, 
                        self.SPEED_TURN_VERY_SHARP, 
                        self.SPEED_TURN_VERY_SHARP
                    )
                elif infrared_value == 6:  # Line further to the right
                    # Sharper left turn
                    self.motor.set_motor_model(
                        -self.SPEED_TURN_SHARP, 
                        -self.SPEED_TURN_SHARP, 
                        self.SPEED_TURN_VERY_SHARP * 2, 
                        self.SPEED_TURN_VERY_SHARP * 2
                    )
                elif infrared_value == 1:  # Line slightly to the left
                    # Gentle right turn
                    self.motor.set_motor_model(
                        self.SPEED_TURN_VERY_SHARP, 
                        self.SPEED_TURN_VERY_SHARP, 
                        -self.SPEED_TURN_MEDIUM, 
                        -self.SPEED_TURN_MEDIUM
                    )
                elif infrared_value == 3:  # Line further to the left
                    # Sharper right turn
                    self.motor.set_motor_model(
                        self.SPEED_TURN_VERY_SHARP * 2, 
                        self.SPEED_TURN_VERY_SHARP * 2, 
                        -self.SPEED_TURN_SHARP, 
                        -self.SPEED_TURN_SHARP
                    )
                elif infrared_value == 7:  # All sensors off line or stop condition
                    # Stop
                    self.motor.set_motor_model(0, 0, 0, 0)
                else:
                    # Default: stop for unexpected values
                    print(f"Unexpected sensor value: {infrared_value}")
                    self.motor.set_motor_model(0, 0, 0, 0)
                    
            except Exception as e:
                print(f"Error reading sensors: {e}")
                self.motor.set_motor_model(0, 0, 0, 0)
    
    def close(self):
        """Cleanup resources"""
        self.motor.set_motor_model(0, 0, 0, 0)
        # Close other components if needed


def test_car_infrared():
    """Test function for infrared line following"""
    car = Car()
    print("Starting infrared line following mode...")
    print("Press Ctrl+C to stop")
    
    try:
        while True:
            car.mode_infrared()
            time.sleep(0.01)  # Small delay to prevent CPU overuse
            
    except KeyboardInterrupt:
        print("\nStopping car...")
    finally:
        car.close()
        print("End of program")


if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: python script.py [mode]")
        print("Modes: infrared, ultrasonic, etc.")
        sys.exit(1)
    
    mode = sys.argv[1].lower()
    
    if mode == 'infrared':
        test_car_infrared()
    else:
        print(f"Unknown mode: {mode}")
        print("Available modes: infrared")
